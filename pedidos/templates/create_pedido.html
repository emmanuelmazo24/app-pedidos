{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h1 class="text-center text-uppercase"><ion-icon name="clipboard-outline"></ion-icon>Crear Pedidos</h1>

  <div class="alert alert-danger {% if not error %}d-none {%endif%}" role="alert">    
      {{error}}
  </div>
  <form action="/crear_pedidos/" method="POST" enctype="multipart/form-data">
    {% csrf_token %}    
    <div class="row g-3">
      {% for field in form %}
        <div class="{% if field.label == 'Descripci√≥n' %}col-md-12{% else %}col-md-6{% endif %}">
          {% comment %} {% if field.label != 'Total' %} {% endcomment %}
          <strong>{{ field.label }}</strong>          
          {{ field }}
          {% comment %} {% endif %} {% endcomment %}
          {% if field.errors %}
            <div class="text-danger">{{ field.errors }}</div>
          {% endif %}
        </div>             
      {% endfor %}
    </div>         
    <!-- Contenedor para previsualizaci√≥n -->
    <div id="preview" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
      <img id = "id_img_jugadores_vp" src="" alt="Imagen Jugadores" style="display: none; height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
      <img id = "id_img_arquero_vp" src="" alt="Imagen Arquero" style="display: none; height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
      <img id = "id_img_auspicio1_vp" src="" alt="Imagen auspicio 1" style="display: none; height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
      <img id = "id_img_auspicio2_vp" src="" alt="Imagen auspicio 2" style="display: none; height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
      <img id = "id_img_auspicio3_vp" src="" alt="Imagen auspicio 3" style="display: none; height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
      <img id = "id_img_auspicio4_vp" src="" alt="Imagen auspicio 4" style="display: none; height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
      <img id = "id_img_auspicio5_vp" src="" alt="Imagen auspicio 5" style="display: none; height: 100px; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
    </div>
    <div class="table-responsive p-2">
      <table id ="detalle-table" class="table-primary table-bordered">
      {{ formset.management_form }}
      {% for f in formset %}
        <thead>
          <tr>
            <th></th>
            <th>{{ f.nombre.label|safe }}</th>
            <th>{{ f.talle.label|safe }}</th>
            <th>{{ f.dorsal.label|safe }}</th>
            <th>{{ f.molde.label|safe }}</th>
            <th>{{ f.cuello_tipo.label|safe }}</th>
            <th>{{ f.cuello_color.label|safe }}</th>
            <th>{{ f.observacion.label|safe }}</th>
            <th>{{ f.indumentaria.label|safe }}</th>
            <th>{{ f.calidad.label|safe }}</th>
            <th>{{ f.cantidad.label|safe }}</th>
            <th>{{ f.precio_aprobado.label|safe }}</th>
          </tr>
        </thead>
        <tbody id = "formset-body">        
        <tr class="formset-row">
          <td>{{ f.id }}</td>
          <td>{{ f.nombre }}</td>
          <td>{{ f.talle }}</td>
          <td>{{ f.dorsal }}</td>
          <td>{{ f.molde }}</td>
          <td>{{ f.cuello_tipo }}</td>
          <td>{{ f.cuello_color }}</td>
          <td>{{ f.observacion }}</td>
          <td>{{ f.indumentaria }}</td>
          <td>{{ f.calidad }}</td>
          <td>{{ f.cantidad }}</td>
          <td>{{ f.precio_aprobado }}</td>
          <td><button type="button" class="remove-row">‚ùå</button></td>
        </tr>
        </tbody>
      {% endfor %}
      </table>

      <!-- Form vac√≠o oculto -->
      <template id="empty-form">
        <tr class="formset-row">
          <td>{{ formset.empty_form.id }}</td>
          <td>{{ formset.empty_form.nombre }}</td>
          <td>{{ formset.empty_form.talle }}</td>
          <td>{{ formset.empty_form.dorsal }}</td>
          <td>{{ formset.empty_form.molde }}</td>
          <td>{{ formset.empty_form.cuello_tipo }}</td>
          <td>{{ formset.empty_form.cuello_color }}</td>
          <td>{{ formset.empty_form.observacion }}</td>
          <td>{{ formset.empty_form.indumentaria }}</td>
          <td>{{ formset.empty_form.calidad }}</td>
          <td>{{ formset.empty_form.cantidad }}</td>
          <td>{{ formset.empty_form.precio_aprobado }}</td>        
          <td><button type="button" class="remove-row">‚ùå</button></td>
        </tr>
      </template>      
    </div>
    <button type="button" class="btn btn-secondary" id="add-form"><ion-icon name="add-circle-outline"></ion-icon> Agregar detalle</button>
    <button class="btn btn-primary"><ion-icon name="save-outline"></ion-icon> Grabar</button>
  </form>
</div>
{% endblock %}
{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
  let formsetBody = document.getElementById("formset-body");
  let addButton = document.getElementById("add-form");
  let emptyForm = document.getElementById("empty-form").innerHTML;
  let totalForms = document.getElementById("id_detalles-TOTAL_FORMS");
  
  const previewContainer = document.getElementById('preview');
  
  // Agregar nueva fila
  addButton.addEventListener("click", function() {
    let formIndex = totalForms.value;
    //console.log(emptyForm)
    let newRow = emptyForm.replace(/__prefix__/g, formIndex);
    console.log(newRow)
    formsetBody.insertAdjacentHTML("beforeend", newRow);
    totalForms.value = parseInt(formIndex) + 1;
  });

  // Eliminar fila
  formsetBody.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-row")) {
      e.target.closest("tr").remove();
      // üëá Ojo: Django necesita que TOTAL_FORMS refleje solo los forms que env√≠as.
      // Si borras din√°micamente, tendr√≠as que ajustar m√°s la l√≥gica
      // (ejemplo: marcar "DELETE" en lugar de quitar completamente la fila).
    }
  });

  function mostrarVistaPrevia(inputId){    
    const input = document.getElementById(inputId);

    input.addEventListener('change', function () {
      //previewContainer.innerHTML = ''; // Limpiar vista previa anterior
      const files = input.files;

      if (files.length > 0) {
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();

                reader.onload = function (e) {
                  const img = document.getElementById(inputId+'_vp');
                  img.src = e.target.result;   
                  img.style.display = 'block';                
                };

                reader.readAsDataURL(file);
            }
        });
      }
    });
  }  

  function actualizarPrecio(row) {
    const indumentaria = row.querySelector('[name$="-indumentaria"]').value;
    const calidad = row.querySelector('[name$="-calidad"]').value;
    const precioInput = row.querySelector('[name$="-precio_aprobado"]');
    if (indumentaria && calidad) {
      fetch(`/obtener_precio/?indumentaria=${encodeURIComponent(indumentaria)}&calidad=${encodeURIComponent(calidad)}`)
        .then(response => response.json())
        .then(data => {          
          const precioFormateado = parseFloat(data.precio).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          //console.log(precioFormateado);
          precioInput.value = data.precio;
        });
    }
  }

  // Para cada fila existente
  document.querySelectorAll('.formset-row').forEach(row => {
    const indumentariaSelect = row.querySelector('[name$="-indumentaria"]');
    const calidadSelect = row.querySelector('[name$="-calidad"]');
    if (indumentariaSelect && calidadSelect) {
      indumentariaSelect.addEventListener('change', () => actualizarPrecio(row));
      calidadSelect.addEventListener('change', () => actualizarPrecio(row));
    }
  });

  // Para nuevas filas agregadas din√°micamente
  document.getElementById("formset-body").addEventListener("change", function(e) {
    if (e.target.name.endsWith('-indumentaria') || e.target.name.endsWith('-calidad')) {
      const row = e.target.closest('.formset-row');
      actualizarPrecio(row);
    }
  });
  mostrarVistaPrevia('id_img_jugadores')
  mostrarVistaPrevia('id_img_arquero')
  mostrarVistaPrevia('id_img_auspicio1')
  mostrarVistaPrevia('id_img_auspicio2')
  mostrarVistaPrevia('id_img_auspicio3')
  mostrarVistaPrevia('id_img_auspicio4')
  mostrarVistaPrevia('id_img_auspicio5')
});
</script>
{% endblock %}