{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h1 class="text-center text-uppercase"><ion-icon name="clipboard-outline"></ion-icon>Crear Pedidos</h1>

  {{error}}
  <form action="/crear_pedidos/" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="p-2">
      {{form}}
    </div>  
    <div class="p-2">
      {{ imagen_formset }}
    </div>
    <!-- Campo para subir m√∫ltiples im√°genes -->
    <div class="form-group">
      <label>Im√°genes:</label>
      {{ imagen_formset.imagen }}
    </div>
    <!-- Contenedor para previsualizaci√≥n -->
    <div id="preview" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
    <div class="table-responsive p-2">
      <table id ="detalle-table" class="table-primary table-bordered">
      {{ formset.management_form }}
      {% for f in formset %}
        <thead>
          <tr>
            <th>{{ f.nombre.label_tag }}</th>
            <th>{{ f.talle.label_tag }}</th>
            <th>{{ f.dorsal.label_tag }}</th>
            <th>{{ f.molde.label_tag }}</th>
            <th>{{ f.cuello_tipo.label_tag }}</th>
            <th>{{ f.cuello_color.label_tag }}</th>
            <th>{{ f.observacion.label_tag }}</th>
            <th>{{ f.indumentaria.label_tag }}</th>
            <th>{{ f.calidad.label_tag }}</th>
            <th>{{ f.cantidad.label_tag }}</th>
            <th>{{ f.precio_aprobado.label_tag }}</th>
          </tr>
        </thead>
        <tbody id = "formset-body">        
        <tr class="formset-row">
          <td>{{ f.nombre }}</td>
          <td>{{ f.talle }}</td>
          <td>{{ f.dorsal }}</td>
          <td>{{ f.molde }}</td>
          <td>{{ f.cuello_tipo }}</td>
          <td>{{ f.cuello_color }}</td>
          <td>{{ f.observacion }}</td>
          <td>{{ f.indumentaria }}</td>
          <td>{{ f.calidad }}</td>
          <td>{{ f.cantidad }}</td>
          <td>{{ f.precio_aprobado }}</td>
          <td><button type="button" class="remove-row">‚ùå</button></td>
        </tr>
        </tbody>
      {% endfor %}
      </table>

      <!-- Form vac√≠o oculto -->
      <template id="empty-form">
        <tr class="formset-row">
          <td>{{ formset.empty_form.nombre }}</td>
          <td>{{ formset.empty_form.talle }}</td>
          <td>{{ formset.empty_form.dorsal }}</td>
          <td>{{ formset.empty_form.molde }}</td>
          <td>{{ formset.empty_form.cuello_tipo }}</td>
          <td>{{ formset.empty_form.cuello_color }}</td>
          <td>{{ formset.empty_form.observacion }}</td>
          <td>{{ formset.empty_form.indumentaria }}</td>
          <td>{{ formset.empty_form.calidad }}</td>
          <td>{{ formset.empty_form.cantidad }}</td>
          <td>{{ formset.empty_form.precio_aprobado }}</td>        
          <td><button type="button" class="remove-row">‚ùå</button></td>
        </tr>
      </template>      
    </div>
    <button type="button" class="btn btn-secondary" id="add-form"><ion-icon name="add-circle-outline"></ion-icon> Agregar detalle</button>
    <button class="btn btn-primary"><ion-icon name="save-outline"></ion-icon> Grabar</button>
  </form>
</div>
{% endblock %}
{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
  let formsetBody = document.getElementById("formset-body");
  let addButton = document.getElementById("add-form");
  let emptyForm = document.getElementById("empty-form").innerHTML;
  let totalForms = document.getElementById("id_detalles-TOTAL_FORMS");
  
  const previewContainer = document.getElementById('preview');
  
  // Agregar nueva fila
  addButton.addEventListener("click", function() {
    let formIndex = totalForms.value;
    //console.log(emptyForm)
    let newRow = emptyForm.replace(/__prefix__/g, formIndex);
    console.log(newRow)
    formsetBody.insertAdjacentHTML("beforeend", newRow);
    totalForms.value = parseInt(formIndex) + 1;
  });

  // Eliminar fila
  formsetBody.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-row")) {
      e.target.closest("tr").remove();
      // üëá Ojo: Django necesita que TOTAL_FORMS refleje solo los forms que env√≠as.
      // Si borras din√°micamente, tendr√≠as que ajustar m√°s la l√≥gica
      // (ejemplo: marcar "DELETE" en lugar de quitar completamente la fila).
    }
  });

  function mostrarVistaPrevia(inputId){    
    const input = document.getElementById(inputId);

    input.addEventListener('change', function () {
      previewContainer.innerHTML = ''; // Limpiar vista previa anterior
      const files = input.files;

      if (files.length > 0) {
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.height = '100px';
                    img.style.border = '1px solid #ccc';
                    img.style.borderRadius = '4px';
                    img.style.padding = '4px';
                    previewContainer.appendChild(img);
                };

                reader.readAsDataURL(file);
            }
        });
      }
    });
  }  

  function actualizarPrecio(row) {
    const indumentaria = row.querySelector('[name$="-indumentaria"]').value;
    const calidad = row.querySelector('[name$="-calidad"]').value;
    const precioInput = row.querySelector('[name$="-precio_aprobado"]');
    if (indumentaria && calidad) {
      fetch(`/obtener_precio/?indumentaria=${encodeURIComponent(indumentaria)}&calidad=${encodeURIComponent(calidad)}`)
        .then(response => response.json())
        .then(data => {          
          const precioFormateado = parseFloat(data.precio).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          console.log(precioFormateado);
          precioInput.value = data.precio;
        });
    }
  }

  // Para cada fila existente
  document.querySelectorAll('.formset-row').forEach(row => {
    const indumentariaSelect = row.querySelector('[name$="-indumentaria"]');
    const calidadSelect = row.querySelector('[name$="-calidad"]');
    if (indumentariaSelect && calidadSelect) {
      indumentariaSelect.addEventListener('change', () => actualizarPrecio(row));
      calidadSelect.addEventListener('change', () => actualizarPrecio(row));
    }
  });

  // Para nuevas filas agregadas din√°micamente
  document.getElementById("formset-body").addEventListener("change", function(e) {
    if (e.target.name.endsWith('-indumentaria') || e.target.name.endsWith('-calidad')) {
      const row = e.target.closest('.formset-row');
      actualizarPrecio(row);
    }
  });  
});
</script>
{% endblock %}